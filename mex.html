---
layout: section
title: Mexico Topojson
mapsrc: yucatan
---
<nav class="navbar navbar-default" role="navigation">
    <div class="navbar-header text-center">
      <a class="navbar-brand" href="#">Dengue Sim Visualization</a>
    </div>
  </div>
</nav>

<div class="container">
  <div class="col-md-12 form-inline text-center">
    <div class='form-group'>
      <div class='row'>
        <label>Starting day: <input class='input-sm' type="number" id="startingDayBox" class="form-control"  value="0" min="1" max="365" onChange="changeStartDay()"></label>
        <label>Time step: <input class='input-sm' type="number" id="timeStepBox" class="form-control"  value="14" min="1" max="365" size="2" onChange="changeTimeStep()"></label>
        <label>Data set: <select id=dataSetMenu onChange="changeDataSet()" class="form-control" >
          <optgroup label="Medium FOI" data-folder="mfoi">
            <option value="14-vac" >Vaccinate 14 y.o.</option>
            <option value="14c-vac">Vaccinate 14 y.o. + 15-46 catchup campaign</option>
          </optgroup>
          <optgroup label="High FOI" data-folder="hfoi">
            <option value="14-vac" >Vaccinate 14 y.o.</option>
            <option value="14c-vac" selected="selected">Vaccinate 14 y.o. + 15-46 catchup campaign</option>
          </optgroup>
          <!-- <option value="empty" selected='selected'>   Empty  </option> -->
        </select></label>
        <button class="btn btn-success runstate">Start/Stop</button>
        <button  id='restart' class="btn btn-primary" onClick="restartSimulation()">Restart</button>
      </div>
    </div>
  </div>

  <div class='container'>
    <div class="col-md-12">
      <span id='curDayDiv'> &nbsp </span>
      <div id='tsPlotDiv'> </div>
    </div>
  </div>

<div class='container'>

  <div class="col-md-12">
    <span class='col-md-6 text-center text base'> Baseline </span>
    <span class='col-md-6 text-center text vac'> Vaccine starting in year 5 </span>
  </div>

  <div class="col-md-12 displaymaps" id="displaymaps"
    data-map-src="geo_data/{{ page.mapsrc }}/map.json"
    data-map-meta-src="geo_data/{{ page.mapsrc }}/meta.json">
    <div class="col-md-6 map base" id='svgMapDiv1'>
      <svg height="500" width="500"></svg>
    </div>
    <div class="col-md-6 map vac" id='svgMapDiv2'>
      <svg height="500" width="500"></svg>
    </div>
  </div>

</div>

<script>
var mapProps = {
  width  : 500,
  height : 500
};
var tsProps = {
  width  : 1000,
  height : 500
}

var width             = 1000;
var height            = 500;
var timeStep          = changeTimeStep(); // Update polygons this often
var startDay          = 0;
var tsPlotDivHeight   = 150;

var svgMapElement1 =
  d3.select("#svgMapDiv1 svg");
var svgMapElement2 =
  d3.select("#svgMapDiv2 svg");

//var projection = d3.geo.mercator().scale(16000*mapwidth/1100).center([-88.9, 20.8]);
var projection = d3.geo.mercator().scale(18 * mapProps.width).center([-87.5, 20.3]);
var path_projector = d3.geo.path().projection(projection);

var curDay=0;
var timeSeriesX=undefined;
var timeSeriesY=undefined;
var timeSeriesIndicatorBar=undefined;
var timeSeriesIndicatorText=undefined;
var xAxisSVGElement=undefined;

var unprocessedEvents1=[];
var unprocessedEvents2=[];
var updateFunctionTimer=undefined;
var lastDayLength=1;

function changeStartDay()        { startDay=parseInt($("#startingDayBox").val()); curDay=startDay; return startDay; }
function changeTimeStep()        { timeStep=parseInt($("#timeStepBox").val()); return timeStep; }
function changeDataSet() {
  var $s = $('#dataSetMenu');
  console.log($s.find(':selected').parent());
  var tar = $s.find(':selected').parent().data('folder');
  var intervention = $s.val();
  //dataSet = document.getElementById('dataSetMenu').value;
  $.when(getDataset1(tar+"/base.json"), getDataset2(tar+"/"+intervention+".json")).done(function(){
    curDay = startDay;
    drawTsPlot(unprocessedEvents1, unprocessedEvents2);

  });
}

function restartSimulation()     { changeStartDay();}

startDay = changeStartDay();

function drawTsPlot(baseEvents, interventionEvents) {
    if (baseEvents.length == 0  || interventionEvents.length == 0) return;

    d3.select("#tsPlotDiv").selectAll("svg").remove()
    var tsPlotElement = d3.select("#tsPlotDiv").append("svg").attr("width", width).attr("height", tsPlotDivHeight);
    tsPlotElement.selectAll('g').remove()
    tsPlotElement.selectAll('path').remove()
    tsPlotElement.selectAll('text').remove()

    var data1 = calculateTimeSeriesData(baseEvents);
    var data2 = calculateTimeSeriesData(interventionEvents);

    //http://www.janwillemtulp.com/2011/04/01/tutorial-line-chart-in-d3/
    //http://bl.ocks.org/mbostock/3883245
    //http://square.github.io/cubism/

    var margin = {top: 20, right: 0, bottom: 20, left: 80};
    timeSeriesX = d3.scale.linear().range([margin.left, width - margin.right]);
    timeSeriesY = d3.scale.linear().range([tsPlotDivHeight - margin.bottom, margin.top]);

    var xDomain = d3.extent(data1, function(d) { return d[0]; });
    //console.log(xDomain);
    timeSeriesX.domain(xDomain);
    var yDomain1 = d3.extent(data1, function(d) { return d[1]; });
    var yDomain2 = d3.extent(data2, function(d) { return d[1]; });

    var yDomain = [0,Math.max(yDomain1[1], yDomain2[1])];
    //yDomain[0] = 0; //-0.1 * yDomain[1]; // This makes it possible to draw a circle that's not cropped
    timeSeriesY.domain(yDomain);

    var num_years = 25;
    var xAxis = d3.svg.axis()
    //              .scale(timeSeriesX)
                  .scale( d3.scale.linear().domain([0, num_years]).range([margin.left, width - margin.right]) )
                  .ticks(6)
                  .orient("bottom");
    var yDomainMagnitude = Math.floor(Math.log(yDomain[1])/Math.LN10);
    var yMaxTick = Math.floor(yDomain[1]/Math.pow(10,yDomainMagnitude)) * Math.pow(10,yDomainMagnitude);
    var yTicks = [0, Math.round(yMaxTick/2), yMaxTick]
    var yAxis = d3.svg.axis()
                  .scale(timeSeriesY)
                  .tickValues(yTicks)
                  .orient("left");


    var line = d3.svg.line()
        .x(function(d) { return timeSeriesX(d[0]); })
        .y(function(d) { return timeSeriesY(d[1]); });

    tsPlotElement
        .attr("width", width + margin.left + margin.right)
        .attr("height", tsPlotDivHeight + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var xAxisOffset = tsPlotDivHeight - 10;

     tsPlotElement.append("g")
        .attr("id", "xaxis")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + xAxisOffset + ")")
        .call(xAxis)
        .append("text")
        .attr("x", (margin.left + width)/2)
        .attr("dx", "-.71em")
        .attr("y", 40)
        //.style("text-anchor", "end")
        .text("Year");

    tsPlotElement.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + 50 + ",0)")
        .call(yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Incidence");

    tsPlotElement.append("path")
        .datum(data1)
        .attr("class", "line base")
        .attr("d", line);

    tsPlotElement.append("path")
        .datum(data2)
        .attr("class", "line vac")
        .attr("d", line);

    var drag = d3.behavior.drag()
        .on("dragstart", dragstarted)
        .on("drag", dragged)
        .on("dragend", dragended);
    // http://square.github.io/cubism/demo/

    datapoint = {'x':0, 'y':0};

    // vaccination indicator bar
    tsPlotElement.append("g")
        .attr("class", "bar")
        .selectAll("rect")
        .data([datapoint])
        .enter().append("rect")
        .attr("stroke","transparent")
        .attr("fill", "rgba(51,127,204,0.3)")
        .attr("x", timeSeriesX(5*365) )
        .attr("y", tsPlotDivHeight - margin.bottom + 3)
        .attr("width", width - timeSeriesX(5*365))
        .attr("height", 4)
        .call(drag);

    var barWidth = 10;

    timeSeriesIndicatorBar = tsPlotElement.append("g")
        .attr("class", "sliding bar")
        .selectAll("rect")
        .data([datapoint])
        .enter().append("rect")
        .attr("stroke","transparent")
        .attr("fill", "rgba(255,0,0,.5)")
        .attr("x", 0 )
        .attr("y", 0)
        .attr("width", barWidth)
        .attr("height", tsPlotDivHeight - margin.bottom + 5)
        .call(drag);

    timeSeriesIndicatorBarText = tsPlotElement.append("text")
        .attr({
          id: "timeSeriesIndicatorBarText",
          x: 0, y: 5,
          dy: ".71em", fill: "red"
        });

    updateTimeSeriesIndicator(startDay,"# of infections");
}

function getDataset1(dataSetFilename) {
  return $.get("epi_data/".concat(dataSetFilename), function(json_string) {
         console.log("Done downloading1...processing");
         unprocessedEvents1 = json_string;
         // TODO change to storage on something?
  });
}

function getDataset2(dataSetFilename) {
  return $.get("epi_data/".concat(dataSetFilename), function(json_string) {
         console.log("Done downloading2...processing");
         unprocessedEvents2 = json_string;
         // TODO change to storage on something?
  });
}

function updateTimeSeriesIndicator(dayNumber, numInf) {
  timeSeriesIndicatorBar
    .attr("x", timeSeriesX(dayNumber))
  timeSeriesIndicatorBarText
    .attr("x", timeSeriesX(dayNumber)+20)
    .text(numInf);
}

function update() {
    if ((curDay-startDay) % timeStep == 0){
        updatePolygonColors(curDay, timeStep, unprocessedEvents1, svgMapElement1, "left");
        updatePolygonColors(curDay, timeStep, unprocessedEvents2, svgMapElement2, "right");
    }

    drawDailyEvents(curDay, unprocessedEvents1);

    curDay++;
    if (curDay > unprocessedEvents1.length) curDay = 0;
}

function dragstarted(d) {
    stopSimulation();
    d3.event.sourceEvent.stopPropagation();
    d3.select(this).classed("dragging", true);
}

function dragged(d) {
    //console.log(d);
    var bbox = document.getElementById('xaxis').getBoundingClientRect();
    var estimateDay = ((d.x-100+5)/(bbox.width-5))*unprocessedEvents1.length;
    //var estimateDay = ((d.x-80+5)/(bbox.width-5))*1000;//*unprocessedEvents1.length;
    estimateDay = estimateDay < 0 ? 0 : estimateDay;
    $("#startingDayBox").val(Math.round(estimateDay));
    changeStartDay();
    update();
    var barPos = d3.event.x - 5;
    barPos = barPos < 75 ? 75 :
             barPos > bbox.width + 70 ? bbox.width + 70 :
             barPos;
    //console.log(barPos);

    timeSeriesIndicatorBar.attr("x", d.x = barPos);
    timeSeriesIndicatorBarText.attr("x", d.x = barPos+20);

}

function dragended(d) {
    d3.select(this).classed("dragging", false);
//    startSimulation();
}

changeDataSet()
drawMap(svgMapElement1, $('#displaymaps').data('mapSrc'));
drawMap(svgMapElement2, $('#displaymaps').data('mapSrc'));

</script>
