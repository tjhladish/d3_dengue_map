---
layout: section
title: Mexico Topojson
mapsrc: yucatan
---
<nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Dengue Sim Visualization</a>
      <div class='form-inline'>
        <button class="btn btn-success runstate">Start/Stop</button>
        <button  id='restart' class="btn btn-primary" onClick="restartSimulation()">Restart</button>
      </div>
    </div>
  </div>
</nav>

<div class="container">
  <div class="col-md-12 form-inline">
    <div class='form-group'>
      <div class='row'>
        <label>Starting day: <input class='input-sm' type="number" id="startingDayBox" class="form-control"  value="0" min="1" max="365" onChange="changeStartDay()"></label>
        <label>Time step: <input class='input-sm' type="number" id="timeStepBox" class="form-control"  value="14" min="1" max="365" size="2" onChange="changeTimeStep()"></label>
        <label>Data set: <select id=dataSetMenu onChange="changeDataSet()" class="form-control" >
          <optgroup label="Medium FOI" data-folder="mfoi">
            <option value="14-vac" >Vaccinate 14 y.o.</option>
            <option value="14c-vac">Vaccinate 14 y.o. + 15-46 catchup campaign</option>
          </optgroup>
          <optgroup label="High FOI" data-folder="hfoi">
            <option value="14-vac" >Vaccinate 14 y.o.</option>
            <option value="14c-vac" selected="selected">Vaccinate 14 y.o. + 15-46 catchup campaign</option>
          </optgroup>
          <!-- <option value="empty" selected='selected'>   Empty  </option> -->
        </select></label>
      </div>
    </div>
  </div>

  <div class='container'>
    <div class="col-md-12">
      <span id='curDayDiv'> &nbsp </span>
      <div id='tsPlotDiv'> </div>
    </div>
  </div>

<div class='container'>

  <div class="col-md-12">
    <span class='col-md-6 text-center text base'> Baseline </span>
    <span class='col-md-6 text-center text vac'> Vaccine starting in year 5 </span>
  </div>

  <div class="col-md-12 displaymaps" data-map-src="geo_data/{{ page.mapsrc }}/map.json">
    <div class="col-md-6 map" id='svgMapDiv1'>
      <svg height="500" width="500"></svg>
    </div>
    <div class="col-md-6 map" id='svgMapDiv2'>
      <svg height="500" width="500"></svg>
    </div>
  </div>

</div>

<script>
var mapProps = {
  width  : 500,
  height : 500
};
var tsProps = {
  width  : 1000,
  height : 500
}

var width             = 1000;
var height            = 500;
var timeStep          = changeTimeStep(); // Update polygons this often
var startDay          = 0;
var tsPlotDivHeight   = 150;

var svgMapElement1 =
  d3.select("#svgMapDiv1 svg");
var svgMapElement2 =
  d3.select("#svgMapDiv2 svg");

//var projection = d3.geo.mercator().scale(16000*mapwidth/1100).center([-88.9, 20.8]);
var projection = d3.geo.mercator().scale(18 * mapProps.width).center([-87.5, 20.3]);
var path_projector = d3.geo.path().projection(projection);

var curDay=0;
var timeSeriesX=undefined;
var timeSeriesY=undefined;
var timeSeriesIndicatorBar=undefined;
var timeSeriesIndicatorText=undefined;
var xAxisSVGElement=undefined;

var unprocessedEvents1=[];
var unprocessedEvents2=[];
var muniMetaData={};
var updateFunctionTimer=undefined;
var lastDayLength=1;

function changeStartDay()        { startDay=parseInt($("#startingDayBox").val()); curDay=startDay; return startDay; }
function changeTimeStep()        { timeStep=parseInt($("#timeStepBox").val()); return timeStep; }
function changeDataSet() {
  var $s = $('#dataSetMenu');
  console.log($s.find(':selected').parent());
  var tar = $s.find(':selected').parent().data('folder');
  var intervention = $s.val();
  //dataSet = document.getElementById('dataSetMenu').value;
  getDataset1(tar+"/base.json");
  getDataset2(tar+"/"+intervention+".json");
}

function restartSimulation()     { changeStartDay();}

startDay = changeStartDay();

function drawTsPlot() {
    if (unprocessedEvents1.length == 0  || unprocessedEvents2.length == 0) return;

    d3.select("#tsPlotDiv").selectAll("svg").remove()
    var tsPlotElement = d3.select("#tsPlotDiv").append("svg").attr("width", width).attr("height", tsPlotDivHeight);
    tsPlotElement.selectAll('g').remove()
    tsPlotElement.selectAll('path').remove()
    tsPlotElement.selectAll('text').remove()

    var data1 = calculateTimeSeriesData(unprocessedEvents1);
    var data2 = calculateTimeSeriesData(unprocessedEvents2);

    //http://www.janwillemtulp.com/2011/04/01/tutorial-line-chart-in-d3/
    //http://bl.ocks.org/mbostock/3883245
    //http://square.github.io/cubism/

    var margin = {top: 20, right: 0, bottom: 20, left: 80};
    timeSeriesX = d3.scale.linear().range([margin.left, width - margin.right]);
    timeSeriesY = d3.scale.linear().range([tsPlotDivHeight - margin.bottom, margin.top]);

    var xDomain = d3.extent(data1, function(d) { return d[0]; });
    //console.log(xDomain);
    timeSeriesX.domain(xDomain);
    var yDomain1 = d3.extent(data1, function(d) { return d[1]; });
    var yDomain2 = d3.extent(data2, function(d) { return d[1]; });
    //console.log(yDomain1);
    //console.log(yDomain2);

    var yDomain = [0,Math.max(yDomain1[1], yDomain2[1])];
    //yDomain[0] = 0; //-0.1 * yDomain[1]; // This makes it possible to draw a circle that's not cropped
    timeSeriesY.domain(yDomain);

    var num_years = 25;
    var xAxis = d3.svg.axis()
    //              .scale(timeSeriesX)
                  .scale( d3.scale.linear().domain([0, num_years]).range([margin.left, width - margin.right]) )
                  .ticks(6)
                  .orient("bottom");
    var yDomainMagnitude = Math.floor(Math.log(yDomain[1])/Math.LN10);
    var yMaxTick = Math.floor(yDomain[1]/Math.pow(10,yDomainMagnitude)) * Math.pow(10,yDomainMagnitude);
    var yTicks = [0, Math.round(yMaxTick/2), yMaxTick]
    var yAxis = d3.svg.axis()
                  .scale(timeSeriesY)
                  .tickValues(yTicks)
                  .orient("left");


    var line = d3.svg.line()
        .x(function(d) { return timeSeriesX(d[0]); })
        .y(function(d) { return timeSeriesY(d[1]); });

    tsPlotElement
        .attr("width", width + margin.left + margin.right)
        .attr("height", tsPlotDivHeight + margin.top + margin.bottom)
        .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var xAxisOffset = tsPlotDivHeight - 10;

     tsPlotElement.append("g")
        .attr("id", "xaxis")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + xAxisOffset + ")")
        .call(xAxis)
        .append("text")
        .attr("x", (margin.left + width)/2)
        .attr("dx", "-.71em")
        .attr("y", 40)
        //.style("text-anchor", "end")
        .text("Year");

    tsPlotElement.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + 50 + ",0)")
        .call(yAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Incidence");

    tsPlotElement.append("path")
        .datum(data1)
        .attr("class", "line base")
        .attr("d", line);

    tsPlotElement.append("path")
        .datum(data2)
        .attr("class", "line vac")
        .attr("d", line);

    var drag = d3.behavior.drag()
        .on("dragstart", dragstarted)
        .on("drag", dragged)
        .on("dragend", dragended);
    // http://square.github.io/cubism/demo/

    datapoint = {'x':0, 'y':0};

    // vaccination indicator bar
    tsPlotElement.append("g")
        .attr("class", "bar")
        .selectAll("rect")
        .data([datapoint])
        .enter().append("rect")
        .attr("stroke","transparent")
        .attr("fill", "rgba(51,127,204,0.3)")
        .attr("x", timeSeriesX(5*365) )
        .attr("y", tsPlotDivHeight - margin.bottom + 3)
        .attr("width", width - timeSeriesX(5*365))
        .attr("height", 4)
        .call(drag);

    var barWidth = 10;

    timeSeriesIndicatorBar = tsPlotElement.append("g")
        .attr("class", "sliding bar")
        .selectAll("rect")
        .data([datapoint])
        .enter().append("rect")
        .attr("stroke","transparent")
        .attr("fill", "rgba(255,0,0,.5)")
        .attr("x", 0 )
        .attr("y", 0)
        .attr("width", barWidth)
        .attr("height", tsPlotDivHeight - margin.bottom + 5)
        .call(drag);

    timeSeriesIndicatorBarText = tsPlotElement.append("text")
        .attr({
          id: "timeSeriesIndicatorBarText",
          x: 0, y: 5,
          dy: ".71em", fill: "red"
        });

    updateTimeSeriesIndicator(startDay,"# of infections");
}

function drawMap(svgMapObject) {

    var graticule = d3.geo.graticule();
        graticule.precision(0.001);
        graticule.extent([[-89.5,20.5],[-88.5,21.5]]);

    d3.json("yuc_muni2.json", function(error, mx) {
      svgMapObject.selectAll("path")
        .data(topojson.object(mx, mx.objects.yucatan_municipalities).geometries)
        .enter().append("path")
        .attr("d", path_projector)
        .style("stroke", "#333")
        .style("stroke-width", ".2px")
        .attr("class", "myyuc")
        .style("fill", "white");

     var g = svgMapObject.append("g");

      g.selectAll("path")
        .data(topojson.object(mx, mx.objects.MEX_adm1).geometries)
        .enter().append("path")
        .attr("d", path_projector)
        .attr("fill", "transparent")
        .style("stroke", "#333");

       svgMapObject.append("path")
       .datum(graticule)
       .attr("class", "graticule")
       .attr("d", path_projector);

    });
}

function getDataset1(dataSetFilename) {
  $.get("epi_data/".concat(dataSetFilename), function(json_string) {
         console.log("Done downloading1...processing");
         unprocessedEvents1 = json_string;
         curDay=startDay;
         drawTsPlot();
  });
}

function getDataset2(dataSetFilename) {
  $.get("epi_data/".concat(dataSetFilename), function(json_string) {
         console.log("Done downloading2...processing");
         unprocessedEvents2 = json_string;
         curDay=startDay;
         drawTsPlot();
  });
}

function getMuniMetaData() {
  $.get("muni_meta_data.json", function(json_string) {
         console.log("Done downloading muni meta data processing");
         muniMetaData = json_string;  //already in json format
  });
}


function getColor(value) {
    var min=0;  var max=5;
    var s = (value-min)/(max-min);
    return d3.hsl(360.0, 100,0.5); //h,s,l red
}

function updatePolygonColors(timeStep, unprocessedEvents, svgMapObject, position) {
    //muniColorLookup
    var muni_prevalence={};
    var infection_ct=0;

    var _startDay = curDay;
    if(_startDay > unprocessedEvents.length) { _startDay=0; curDay=0; }
    var endDay = _startDay+timeStep;
    if(endDay > unprocessedEvents.length) endDay=unprocessedEvents.length;

    for(day=_startDay; day < endDay; day++ ) {
        var curDayPoints = unprocessedEvents[day];  //all muni pairs
        if (curDayPoints != null ) {
            // tally infections for each municipality
            for(muni in curDayPoints ) {
                if (muni == 'total') continue;
                infection_ct =curDayPoints[muni];

                if(muni in muni_prevalence) {
                    muni_prevalence[muni] += infection_ct;
                } else {
                  muni_prevalence[muni] = infection_ct;
                }
            }
        }
    }

    //console.log(muni_prevalence);

    //color municipalities by incidence
    muni_objects=svgMapObject.selectAll(".myyuc")[0];        //array of arrays..first element
    for(midx=0; midx<muni_objects.length; midx++ ) { //106
        if(midx in muni_prevalence) {
            yvalue=muni_prevalence[midx];
            populationSize = muniMetaData[midx]["pop"];
            if ( populationSize == undefined) populationSize=1;
            intensity_rescale = 1000.0/timeStep;
            yvalue = intensity_rescale * (yvalue/populationSize)*255;

            if (yvalue > 255) { yvalue = 255; }
            if (position == "left") {
                muni_objects[midx].style["fill"] = d3.rgb(255-yvalue*0.1, 255-yvalue*0.5, 255-yvalue*0.8);
            } else {
                muni_objects[midx].style["fill"] = d3.rgb(255-yvalue*0.8,255-yvalue*0.5,255-yvalue*0.2);
            }
        } else {
            //yvalue =Math.round(Math.random()*255);
            //muni_objects[midx].style["fill"] = d3.rgb(255-yvalue*0.8,255-yvalue*0.5,255-yvalue*0.2);
            muni_objects[midx].style["fill"] = "white";
        }
    }

    if (position == "right") {
        $("#curDayDiv").html("Current period: " + _startDay + "-" + endDay );
    }

}

function calculateTimeSeriesData(unprocessedEvents) {
    var data = [];
    for(i=0; i < unprocessedEvents.length; i++ ) {   //number of days
        var curDayPoints = unprocessedEvents[i];     //array of [muni, ct] pairs
        var numInf=0;
        if (curDayPoints != null ) {
              numInf = curDayPoints['total'];
        }
        data[i]=[i,numInf];
   }
   return data;
}

function updateTimeSeriesIndicator(dayNumber,numInf) {
  //console.log(d3.select('#tsPlotDiv svg g.sliding.bar')); //.attr("x", timeSeriesX(dayNumber));
  //d3.select('#tsPlotDiv svg g.sliding.bar').attr("x", timeSeriesX(dayNumber))
  timeSeriesIndicatorBar.attr("x", timeSeriesX(dayNumber))
  timeSeriesIndicatorBarText.attr("x", timeSeriesX(dayNumber)+20);
  timeSeriesIndicatorBarText.text(numInf);
}


function drawDailyEvents(dayNumber,unprocessedEvents) {
    var curDayPoints = unprocessedEvents[dayNumber];
    if (curDayPoints != null ) {
        var numInf=curDayPoints['total'];
        updateTimeSeriesIndicator(dayNumber, numInf);
    }
}

function update() {
    if ((curDay-startDay) % timeStep == 0){
        updatePolygonColors(timeStep,unprocessedEvents1,svgMapElement1, "left");
        updatePolygonColors(timeStep,unprocessedEvents2,svgMapElement2, "right");
    }

    drawDailyEvents(curDay, unprocessedEvents1);

    curDay++;
    if (curDay > unprocessedEvents1.length) curDay = 0;
}

function dragstarted(d) {
    stopSimulation();
    d3.event.sourceEvent.stopPropagation();
    d3.select(this).classed("dragging", true);
}

function dragged(d) {
    //console.log(d);
    var bbox = document.getElementById('xaxis').getBoundingClientRect();
    var estimateDay = ((d.x-100+5)/(bbox.width-5))*unprocessedEvents1.length;
    //var estimateDay = ((d.x-80+5)/(bbox.width-5))*1000;//*unprocessedEvents1.length;
    estimateDay = estimateDay < 0 ? 0 : estimateDay;
    $("#startingDayBox").val(Math.round(estimateDay));
    changeStartDay();
    update();
    var barPos = d3.event.x - 5;
    barPos = barPos < 75 ? 75 :
             barPos > bbox.width + 70 ? bbox.width + 70 :
             barPos;
    //console.log(barPos);

    timeSeriesIndicatorBar.attr("x", d.x = barPos);
    timeSeriesIndicatorBarText.attr("x", d.x = barPos+20);

}

function dragended(d) {
    d3.select(this).classed("dragging", false);
//    startSimulation();
}

changeDataSet()
drawMap(svgMapElement1);
drawMap(svgMapElement2);
getMuniMetaData();

</script>
