<!DOCTYPE html>
<meta charset="utf-8">
<title>Mexico Topojson</title>
<style>

.graticule { fill: none; stroke: #000; stroke-opacity: .3; stroke-width: .5px; }

.graticule.outline { stroke: #333; stroke-opacity: 1; stroke-width: 1.5px; }


</style>

<body>
<script src="http://d3js.org/d3.v3.js"></script>
<script src="http://d3js.org/topojson.v0.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

Starting day: <input type="number" id="startingDayBox" value="100" min="1" max="365" onChange="changeStartDay()"> <br>
Time step: <input type="number" id="timeStepBox" value="30" min="1" max="365" size="2" onChange="changeTimeStep()"> <br>
Expansion Factor: <input type="number" id="expansionFactorBox" value="36" min="1" max="100" onChange="changeExpansionFactor()">  <br>

<button id='startStopButton' onClick="runSimulation()">Start/Stop</button> 
<button id='restart' onClick="restartSimulation()">Restart</button> <br>

<div id='curDayDiv' style='font-size:bigger'></div><br>
<div id='infectionsDiv' style='font-size:bigger'></div>

<script>

var width = 1200;
var height = 800;
var timeStep = changeTimeStep(); // Update polygons this often
var expansionFactor =changeExpansionFactor();
var startDay = changeStartDay();

var projection = d3.geo.mercator()
//var projection = d3.geo.kavrayskiy7()
    .scale(15000)
    .center([-89, 21]);

var svg = d3.select("body").append("svg").attr("width", width).attr("height", height);
var g = svg.append("g");

//var projection = d3.geo.kavrayskiy7();
var    color = d3.scale.category20();
    graticule = d3.geo.graticule();
    graticule.precision(0.001);
    //graticule.minorStep([.4667,.4667]);
    //graticule.minorStep([0.0041666700,0.0041666700]);
    graticule.extent([[-89.5,20.5],[-88.5,21.5]]);

var pixel_width = 0.0041666700;
var pixel_width = pixel_width*4;

var FEATURELIST = [];
//var FEATURELIST = { "type": "FeatureCollection", "features": [] };
XMIN=-91; XMAX=-88; XSTEP=pixel_width;
YMIN=20; YMAX=22; YSTEP=pixel_width;
for(x=XMIN; x < XMAX; x+=XSTEP ) {
    for(y=YMIN; y < YMAX; y+=YSTEP ) {
        var feature = { "type": "Feature",
           "geometry": {
             "type": "Polygon",
             "coordinates": [ [ [x, y], [x, y+YSTEP], [x+XSTEP, y+YSTEP], [x+XSTEP, y], [x, y]] ]
           }
        };
        FEATURELIST.push(feature);
    }
}

var test_rect = { "type": "Feature",
       "geometry": {
         "type": "Polygon",
         "coordinates": [
           [ [-89.5, 20.5], [-89.5, 21.5], [-88.5, 21.5], [-88.5, 20.5], [-89.5, 20.5]]
           ]
       }
};


var path_projector = d3.geo.path().projection(projection);

d3.json("yuc_muni2.json", function(error, mx) {
  svg.selectAll("path")
    .data(topojson.object(mx, mx.objects.yucatan_municipalities).geometries)
    .enter().append("path")
    .attr("d", path_projector)
    .style("stroke", "#333")
    .style("stroke-width", ".2px")
    .attr("class", "myyuc")
    .style("fill", "white");
   //.style("fill", function(){  colorNum=Math.round(Math.random()*100) % 9; return FILLS[colorNum]; });
   // .style("fill", "transparent");
   // .attr("class", function(){  myclass="myyuc q" + (Math.round(Math.random()*100) % 10); return myclass; }); 
  
  g.selectAll("path")
    .data(topojson.object(mx, mx.objects.MEX_adm1).geometries)
    .enter().append("path")
    .attr("d", path_projector)
    .attr("fill", "transparent")
    .style("stroke", "#333");

   svg.append("path")
   .datum(graticule)
   .attr("class", "graticule")
   .attr("d", path_projector);


});

var curDay=0;
var unprocessedEvents=[];
var muniMetaData={};
var displayedStash=[];
var updateFunctionTimer=undefined;

function getDataset() { 
  $.get("epi_data/simulator_output.json", function(json_string) { 
         console.log("Done downloading...processing");
        // unprocessedEvents = jQuery.parseJSON(json_string);
         unprocessedEvents = json_string;
         curDay=0;
  });
}

function getMuniMetaData() { 
  $.get("muni_meta_data.json", function(json_string) { 
         console.log("Done downloading muni meta data processing");
         muniMetaData = json_string;  //already in json format
  });
}


function getColor(value) {
    var min=0;  var max=5;
    var s = (value-min)/(max-min);
    return d3.hsl(360.0, 100,0.5); //h,s,l red
}

function updatePolygonColors(timeStep) {
    //muniColorLookup
    var muni_prevalence={};
    var infection_ct=0;

    var _startDay = curDay;
    if(_startDay > unprocessedEvents.length) { _startDay=0; curDay=0; }
    var endDay = _startDay+timeStep;
    if(endDay > unprocessedEvents.length) endDay=unprocessedEvents.length;

    for(day=_startDay; day < endDay; day++ ) {
        var curDayPoints = unprocessedEvents[day];
        if (curDayPoints != null ) {
            // tally infections for each municipality
            for(i=0; i<curDayPoints.length; i++) {
                d = curDayPoints[i];
                muni =  d[3];
                infection_ct += d[2];
                if(muni in muni_prevalence) { muni_prevalence[muni]+=d[2]; } else { muni_prevalence[muni]=d[2];}
            }
        }
    }
        
    //color municipalities by incidence
    muni_objects=svg.selectAll(".myyuc")[0];        //array of arrays..first element 
    for(midx=0; midx<muni_objects.length; midx++ ) { //106
        if(midx in muni_prevalence) {
            yvalue=muni_prevalence[midx];
            populationSize = muniMetaData[midx]["pop"];
            if ( populationSize == undefined) populationSize=1;
            intensity_rescale = 1000.0/timeStep;
            yvalue = intensity_rescale * (yvalue/populationSize)*255;

            if (yvalue > 255) { yvalue = 255; }
            muni_objects[midx].style["fill"] = d3.rgb(255-yvalue,255-yvalue,255);
        } else {
            muni_objects[midx].style["fill"] = "white";
        }
    }

    $("#curDayDiv").html("Current Period:" + _startDay + "-" + endDay );
    $("#infectionsDiv").html("# Cases:" + infection_ct);

}


function drawDailyEvents(dayNumber) {

    //clear previous infections
    for(i=0;i<displayedStash.length; i++) { displayedStash[i].style("display", "none"); }   //hide

    var curDayPoints = unprocessedEvents[dayNumber];
    if (curDayPoints != null ) {
        // draw each infection
        // Draw only cases, which amount to about 1 out of 36 infections
        //for(i=0; i<curDayPoints.length; i++) {
        for(i=0; i<curDayPoints.length; i += expansionFactor) {
            d = curDayPoints[i];
            coords = projection([d[0],d[1]]);
            cx = coords[0];
            cy = coords[1];
            color = getColor(d[2]);
            muni =  d[3];

            if( i<displayedStash.length) {
                element = displayedStash[i];
                element.style("display","block");
                element.attr("cx", cx).attr("cy",cy).attr("r",1).attr("fill",color);
            } else {
                var element=svg.append("circle").attr("cx", cx).attr("cy",cy).attr("r",1).attr("fill",color);
                displayedStash.push(element); 
            }
        }
    }

    var infection_ct = 0;
    if (curDayPoints != null) { infection_ct = curDayPoints.length; }
   // $("#curDayDiv").html("Current Day:" + dayNumber );
   // $("#infectionsDiv").html("#Infections:" + infection_ct);
}

getMuniMetaData();
getDataset();

function update() { 
    console.log("Update " + timeStep );
    if (curDay % timeStep == 0) updatePolygonColors(timeStep);
    drawDailyEvents(curDay);
    curDay++;
    if (curDay > unprocessedEvents.length) curDay = 0;
}

function runSimulation() { 
    if(updateFunctionTimer == undefined) {
        console.log("Starting simulation");
       // update();  //for debuging 
         updateFunctionTimer = setInterval(update,20);  //r
    } else {
        console.log("Stopping simulation");
        clearInterval(updateFunctionTimer);
        updateFunctionTimer=undefined;
    }
}

function changeStartDay() { startDay=parseInt($("#startDayBox").val()); return startDay; }
function changeTimeStep() { timeStep=parseInt($("#timeStepBox").val()); return timeStep; }
function changeExpansionFactor() { expansionFactor=parseInt($("#expansionFactorBox").val()); return expansionFactor; }


function restartSimulation() { curDay=0;}



</script>

